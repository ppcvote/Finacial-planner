# Ultra Advisor æœƒå“¡ç³»çµ±è¦æ ¼æ›¸ v2.0

## ğŸ“‹ ç³»çµ±æ¦‚è¿°

æ¡ç”¨ã€Œè³¼è²·å¤©æ•¸åˆ¶ã€ï¼Œç”¨æˆ¶ä»˜æ¬¾è³¼è²·ä½¿ç”¨å¤©æ•¸ï¼Œç°¡å–®ç›´è¦ºã€‚

---

## ğŸ”¢ åŸºæœ¬è¨­å®š

| é …ç›® | è¨­å®šå€¼ |
|------|--------|
| è©¦ç”¨å¤©æ•¸ | 7 å¤© |
| å¯¬é™å¤©æ•¸ | 3 å¤© |
| æ¨™æº–æ–¹æ¡ˆ | 365 å¤© / $8,999 |
| è½‰ä»‹ç´¹åƒ¹ | 365 å¤© / $8,000ï¼ˆæŠ˜ $999ï¼‰ |
| æ¨è–¦çå‹µ | é›™æ–¹å„ 500 UA |

---

## ğŸ‘¥ æœƒå“¡èº«åˆ†çµ„

| ID | åç¨± | å·¥å…·æ¬Šé™ | èªªæ˜ |
|---|---|---|---|
| `trial` | è©¦ç”¨æœƒå“¡ | 3 å…è²»å·¥å…· | ä¸€èˆ¬è¨»å†Šï¼Œ7å¤©è©¦ç”¨ |
| `referral_trial` | è½‰ä»‹ç´¹è©¦ç”¨ | 3 å…è²»å·¥å…· | æœ‰æ¨è–¦ç¢¼è¨»å†Šï¼Œ7å¤©è©¦ç”¨ |
| `paid` | ä»˜è²»æœƒå“¡ | å…¨éƒ¨ 18 å·¥å…· | æœ‰å‰©é¤˜å¤©æ•¸ |
| `founder` | å‰µå§‹æœƒå“¡ | å…¨éƒ¨ 18 å·¥å…· | æ°¸ä¹…æ¬Šé™ï¼Œä¸æ‰£å¤©æ•¸ |
| `grace` | å¯¬é™æœŸ | 3 å…è²»å·¥å…· | å¤©æ•¸æ­¸é›¶å¾Œ 3 å¤©ç·©è¡ |
| `expired` | å·²éæœŸ | 3 å…è²»å·¥å…· | éœ€è³¼è²·å¤©æ•¸ |

### å…è²»å·¥å…·ï¼ˆæ‰€æœ‰èº«åˆ†éƒ½å¯ç”¨ï¼‰
- `estate` - é‡‘èæˆ¿ç”¢å°ˆæ¡ˆ
- `reservoir` - å¤§å°æ°´åº«å°ˆæ¡ˆ
- `tax` - ç¨…å‹™å‚³æ‰¿å°ˆæ¡ˆ

---

## ğŸ¯ é»æ•¸å…Œæ›é …ç›®

| é …ç›® | æ‰€éœ€é»æ•¸ | èªªæ˜ |
|------|---------|------|
| å»¶é•· 7 å¤© | 500 UA | daysRemaining +7 |
| å»¶é•· 30 å¤© | 1,800 UA | daysRemaining +30 |
| çºŒè¨‚æŠ˜æŠµ $500 | 2,500 UA | ç”¢ç”ŸæŠ˜æ‰£ç¢¼ |
| çºŒè¨‚æŠ˜æŠµ $1,000 | 4,500 UA | ç”¢ç”ŸæŠ˜æ‰£ç¢¼ |
| å¯¦é«”ç¦®å“ | ä¾å•†å“ | å¾…å®šç¾© |

### é»æ•¸ç²å–æ–¹å¼
| å‹•ä½œ | é»æ•¸ |
|------|------|
| æ¯æ—¥ç™»å…¥ | +5 UA |
| ä½¿ç”¨å·¥å…·ï¼ˆæ¯æ—¥ä¸Šé™10æ¬¡ï¼‰ | +10 UA |
| é€£çºŒç™»å…¥ 7 å¤© | +50 UA |
| é€£çºŒç™»å…¥ 30 å¤© | +200 UA |
| æ¨è–¦å¥½å‹æˆåŠŸ | +500 UAï¼ˆé›™æ–¹å„å¾—ï¼‰ |

---

## ğŸ—„ï¸ Firestore è³‡æ–™çµæ§‹

### users/{uid}
```javascript
{
  // åŸºæœ¬è³‡æ–™
  email: "user@example.com",
  displayName: "ç‹å°æ˜",
  photoURL: "https://...",
  
  // æœƒå“¡ç³»çµ±ï¼ˆå¤©æ•¸åˆ¶ï¼‰
  primaryTierId: "paid",           // èº«åˆ†çµ„
  daysRemaining: 365,              // å‰©é¤˜å¤©æ•¸
  lastDayDeducted: "2025-01-13",   // ä¸Šæ¬¡æ‰£å¤©æ•¸æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  graceDaysRemaining: 0,           // å¯¬é™æœŸå‰©é¤˜å¤©æ•¸
  
  // é»æ•¸ç³»çµ±
  points: {
    current: 1500,                 // ç•¶å‰é»æ•¸
  },
  totalPointsEarned: 2000,
  totalPointsSpent: 500,
  totalPointsExpired: 0,
  
  // æ¨è–¦ç³»çµ±
  referralCode: "WANG123",         // æˆ‘çš„æ¨è–¦ç¢¼
  referredBy: "æ¨è–¦äººUID",          // èª°æ¨è–¦æˆ‘çš„
  referralCount: 3,                // æˆ‘æ¨è–¦äº†å¹¾äºº
  referralRewardClaimed: false,    // æ¨è–¦çå‹µæ˜¯å¦å·²é ˜ï¼ˆä»˜æ¬¾å¾Œæ‰ç™¼ï¼‰
  
  // ç™»å…¥è¿½è¹¤
  loginStreak: 7,
  lastLoginDate: "2025-01-13",
  
  // æ™‚é–“æˆ³
  createdAt: Timestamp,
  updatedAt: Timestamp,
}
```

### referralCodes/{code}
```javascript
{
  code: "WANG123",
  ownerId: "ç”¨æˆ¶UID",
  isActive: true,
  usedCount: 3,
  createdAt: Timestamp,
}
```

### pointsLedger/{docId}
```javascript
{
  userId: "ç”¨æˆ¶UID",
  type: "earn" | "spend" | "expire" | "admin",
  amount: 500,
  reason: "æ¨è–¦å¥½å‹æˆåŠŸ",
  createdAt: Timestamp,
}
```

### redemptionOrders/{docId}
```javascript
{
  userId: "ç”¨æˆ¶UID",
  itemId: "7days",
  itemName: "å»¶é•· 7 å¤©",
  pointsCost: 500,
  status: "completed" | "pending" | "shipped",
  createdAt: Timestamp,
}
```

---

## ğŸ”„ å®Œæ•´æµç¨‹

### æµç¨‹ 1ï¼šæ–°ç”¨æˆ¶è¨»å†Šï¼ˆLINE æ©Ÿå™¨äººï¼‰

```
ç”¨æˆ¶åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿ
        â†“
æ©Ÿå™¨äººï¼šã€Œæ­¡è¿ï¼è«‹è¼¸å…¥æ‚¨çš„ Emailã€
        â†“
ç”¨æˆ¶ï¼šã€Œtest@gmail.comã€
        â†“
æ©Ÿå™¨äººï¼šã€Œè«‹å•æœ‰æœ‹å‹çš„æ¨è–¦ç¢¼å—ï¼Ÿæœ‰è«‹è¼¸å…¥ï¼Œæ²’æœ‰è«‹è¼¸å…¥ã€ç„¡ã€ã€
        â†“
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    æœ‰      ç„¡
    â†“       â†“
é©—è­‰æ¨è–¦ç¢¼  
    â†“       
  æœ‰æ•ˆï¼Ÿ     
  â†™   â†˜    â†“
 æ˜¯    å¦   
 â†“     â†“    â†“
referral  trial  trial
_trial
        â†“
æ©Ÿå™¨äººå»ºç«‹å¸³è™Ÿï¼š
- ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼
- daysRemaining = 7ï¼ˆè©¦ç”¨ï¼‰
- å¯„é€ç™»å…¥è³‡è¨Š
        â†“
æ©Ÿå™¨äººï¼šã€Œå¸³è™Ÿå»ºç«‹æˆåŠŸï¼æ‚¨æœ‰ 7 å¤©å…è²»è©¦ç”¨æœŸã€
```

### æµç¨‹ 2ï¼šè©¦ç”¨è½‰ä»˜è²»

```
ç”¨æˆ¶ç™»å…¥æˆ°æƒ…å®¤
        â†“
é¡¯ç¤ºå‰©é¤˜å¤©æ•¸ï¼šã€Œè©¦ç”¨å‰©é¤˜ 5 å¤©ã€
        â†“
é¡¯ç¤ºå‡ç´šæŒ‰éˆ•ï¼ˆæ ¹æ“šèº«åˆ†çµ„ï¼‰ï¼š
â”œâ”€ trial â†’ ã€Œè³¼è²· 365 å¤© $8,999ã€â†’ åŸåƒ¹é€£çµ
â””â”€ referral_trial â†’ ã€Œè³¼è²· 365 å¤© $8,000ã€â†’ æŠ˜æ‰£é€£çµ
        â†“
ç”¨æˆ¶é»æ“Š â†’ å°å‘ Portaly ä»˜æ¬¾
        â†“
ä»˜æ¬¾æˆåŠŸ â†’ ä½ æ”¶åˆ° Email
        â†“
Admin å¾Œå°ã€Œè™•ç†è¨‚å–®ã€ï¼š
â”œâ”€ è¼¸å…¥ç”¨æˆ¶ Email
â”œâ”€ é»æ“Šã€Œç¢ºèªä»˜æ¬¾ã€
â””â”€ ç³»çµ±è‡ªå‹•ï¼š
   â”œâ”€ primaryTierId â†’ "paid"
   â”œâ”€ daysRemaining + 365
   â””â”€ å¦‚æœ‰æ¨è–¦äºº â†’ é›™æ–¹å„ +500 UA
```

### æµç¨‹ 3ï¼šæ¯æ—¥å¤©æ•¸æ‰£é™¤ï¼ˆCloud Functionï¼‰

```
æ¯æ—¥å‡Œæ™¨ 00:05 åŸ·è¡Œ
        â†“
æŸ¥è©¢æ‰€æœ‰ paid ç”¨æˆ¶ï¼ˆfounder é™¤å¤–ï¼‰
        â†“
æª¢æŸ¥ lastDayDeducted !== ä»Šå¤©
        â†“
    daysRemaining - 1
    lastDayDeducted = ä»Šå¤©
        â†“
æª¢æŸ¥å‰©é¤˜å¤©æ•¸ï¼š
â”œâ”€ å‰© 30 å¤© â†’ ç™¼ LINE é€šçŸ¥ã€Œå¤©æ•¸å‰© 30 å¤©ã€
â”œâ”€ å‰© 7 å¤© â†’ ç™¼ LINE é€šçŸ¥ã€Œå¤©æ•¸å‰© 7 å¤©ï¼Œå¿«çºŒè¨‚ï¼ã€
â”œâ”€ å‰© 0 å¤© â†’ primaryTierId â†’ "grace", graceDaysRemaining = 3
â””â”€ grace ä¸” graceDaysRemaining = 0 â†’ primaryTierId â†’ "expired"
```

### æµç¨‹ 4ï¼šé»æ•¸å…Œæ›å¤©æ•¸

```
ç”¨æˆ¶åœ¨æˆ°æƒ…å®¤é»ã€Œé»æ•¸å•†åŸã€
        â†“
é¸æ“‡ã€Œå»¶é•· 7 å¤©ã€ï¼ˆ500 UAï¼‰
        â†“
ç¢ºèªå…Œæ›
        â†“
Cloud Functionï¼š
â”œâ”€ æª¢æŸ¥é»æ•¸è¶³å¤ 
â”œâ”€ points.current - 500
â”œâ”€ daysRemaining + 7
â”œâ”€ å¦‚æœæ˜¯ expired/grace â†’ primaryTierId â†’ "paid"
â””â”€ è¨˜éŒ„åˆ° pointsLedger + redemptionOrders
        â†“
é¡¯ç¤ºã€Œå…Œæ›æˆåŠŸï¼å¤©æ•¸ +7ã€
```

---

## â˜ï¸ Cloud Functions è¦æ ¼

### 1. validateReferralCodeï¼ˆé©—è­‰æ¨è–¦ç¢¼ï¼‰

```javascript
// è§¸ç™¼ï¼šcallable
// è¼¸å…¥ï¼š{ code: "WANG123" }
// è¼¸å‡ºï¼š{ valid: true, ownerName: "ç‹å°æ˜" } æˆ– { valid: false }

exports.validateReferralCode = functions.https.onCall(async (data, context) => {
  const { code } = data;
  
  // æŸ¥è©¢ referralCodes collection
  const codeDoc = await db.collection('referralCodes').doc(code.toUpperCase()).get();
  
  if (!codeDoc.exists || !codeDoc.data().isActive) {
    return { valid: false };
  }
  
  // å–å¾—æ¨è–¦äººåç¨±
  const ownerDoc = await db.collection('users').doc(codeDoc.data().ownerId).get();
  
  return { 
    valid: true, 
    ownerId: codeDoc.data().ownerId,
    ownerName: ownerDoc.data()?.displayName || 'æœƒå“¡'
  };
});
```

### 2. createUserFromLineï¼ˆLINE è¨»å†Šå»ºç«‹ç”¨æˆ¶ï¼‰

```javascript
// è§¸ç™¼ï¼šcallableï¼ˆå¾ LINE Bot å‘¼å«ï¼‰
// è¼¸å…¥ï¼š{ email, referralCode?, lineUserId }
// è¼¸å‡ºï¼š{ success: true, password: "éš¨æ©Ÿå¯†ç¢¼", tierId: "trial" }

exports.createUserFromLine = functions.https.onCall(async (data, context) => {
  const { email, referralCode, lineUserId } = data;
  
  // 1. ç”¢ç”Ÿéš¨æ©Ÿå¯†ç¢¼
  const password = generateRandomPassword();
  
  // 2. å»ºç«‹ Firebase Auth ç”¨æˆ¶
  const userRecord = await admin.auth().createUser({
    email,
    password,
  });
  
  // 3. æ±ºå®šèº«åˆ†çµ„
  let tierId = 'trial';
  let referredByUid = null;
  
  if (referralCode) {
    const codeDoc = await db.collection('referralCodes').doc(referralCode.toUpperCase()).get();
    if (codeDoc.exists && codeDoc.data().isActive) {
      tierId = 'referral_trial';
      referredByUid = codeDoc.data().ownerId;
    }
  }
  
  // 4. å»ºç«‹ç”¨æˆ¶æ–‡ä»¶
  await db.collection('users').doc(userRecord.uid).set({
    email,
    primaryTierId: tierId,
    daysRemaining: 7,  // è©¦ç”¨ 7 å¤©
    lastDayDeducted: null,
    graceDaysRemaining: 0,
    points: { current: 0 },
    totalPointsEarned: 0,
    totalPointsSpent: 0,
    referralCode: generateReferralCode(),  // ç”¢ç”Ÿè©²ç”¨æˆ¶çš„æ¨è–¦ç¢¼
    referredBy: referredByUid,
    referralRewardClaimed: false,
    lineUserId,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  // 5. å¦‚æœæœ‰æ¨è–¦ç¢¼ï¼Œæ›´æ–°æ¨è–¦äººçš„ referralCount
  if (referredByUid) {
    await db.collection('users').doc(referredByUid).update({
      referralCount: admin.firestore.FieldValue.increment(1),
    });
  }
  
  return { success: true, password, tierId };
});
```

### 3. processPaymentï¼ˆè™•ç†ä»˜æ¬¾ - Admin ç”¨ï¼‰

```javascript
// è§¸ç™¼ï¼šcallableï¼ˆå¾ Admin å¾Œå°å‘¼å«ï¼‰
// è¼¸å…¥ï¼š{ userEmail, days: 365, amount: 8999 }
// è¼¸å‡ºï¼š{ success: true, newDaysRemaining: 372 }

exports.processPayment = functions.https.onCall(async (data, context) => {
  // é©—è­‰æ˜¯å¦ç‚º Admin
  // ...
  
  const { userEmail, days, amount } = data;
  
  // 1. æ‰¾åˆ°ç”¨æˆ¶
  const usersSnapshot = await db.collection('users')
    .where('email', '==', userEmail)
    .limit(1)
    .get();
  
  if (usersSnapshot.empty) {
    throw new functions.https.HttpsError('not-found', 'æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶');
  }
  
  const userDoc = usersSnapshot.docs[0];
  const userData = userDoc.data();
  
  // 2. æ›´æ–°å¤©æ•¸å’Œèº«åˆ†çµ„
  const newDaysRemaining = (userData.daysRemaining || 0) + days;
  
  await userDoc.ref.update({
    primaryTierId: 'paid',
    daysRemaining: newDaysRemaining,
    graceDaysRemaining: 0,
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  // 3. ç™¼æ”¾æ¨è–¦çå‹µï¼ˆå¦‚æœæœ‰æ¨è–¦äººä¸”å°šæœªé ˜å–ï¼‰
  if (userData.referredBy && !userData.referralRewardClaimed) {
    // æ¨è–¦äºº +500
    await awardPoints(userData.referredBy, 500, 'æ¨è–¦å¥½å‹æˆåŠŸ');
    // è¢«æ¨è–¦äºº +500
    await awardPoints(userDoc.id, 500, 'ä½¿ç”¨æ¨è–¦ç¢¼è¨»å†Šçå‹µ');
    // æ¨™è¨˜å·²é ˜å–
    await userDoc.ref.update({ referralRewardClaimed: true });
  }
  
  return { success: true, newDaysRemaining };
});
```

### 4. deductDailyDaysï¼ˆæ¯æ—¥æ‰£å¤©æ•¸ï¼‰

```javascript
// è§¸ç™¼ï¼šscheduledï¼ˆæ¯æ—¥ 00:05ï¼‰
// å°ç£æ™‚é–“ = UTC+8ï¼Œæ‰€ä»¥ cron è¦è¨­ 16:05 UTC

exports.deductDailyDays = functions.pubsub
  .schedule('5 16 * * *')  // UTC 16:05 = å°ç£ 00:05
  .timeZone('UTC')
  .onRun(async (context) => {
    const today = new Date().toISOString().split('T')[0];  // YYYY-MM-DD
    
    // æŸ¥è©¢æ‰€æœ‰ paid ç”¨æˆ¶ï¼ˆæ’é™¤ founderï¼‰
    const paidUsers = await db.collection('users')
      .where('primaryTierId', '==', 'paid')
      .get();
    
    const batch = db.batch();
    const notifications = [];
    
    for (const doc of paidUsers.docs) {
      const data = doc.data();
      
      // è·³éä»Šå¤©å·²æ‰£éçš„
      if (data.lastDayDeducted === today) continue;
      
      const newDays = (data.daysRemaining || 0) - 1;
      
      // æ›´æ–°å¤©æ•¸
      batch.update(doc.ref, {
        daysRemaining: newDays,
        lastDayDeducted: today,
      });
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦é€šçŸ¥æˆ–é™ç´š
      if (newDays === 30 || newDays === 7) {
        notifications.push({
          userId: doc.id,
          lineUserId: data.lineUserId,
          message: `æ‚¨çš„ Ultra Advisor å‰©é¤˜ ${newDays} å¤©ï¼Œè¨˜å¾—çºŒè¨‚å–”ï¼`,
        });
      } else if (newDays <= 0) {
        batch.update(doc.ref, {
          primaryTierId: 'grace',
          daysRemaining: 0,
          graceDaysRemaining: 3,
        });
        notifications.push({
          userId: doc.id,
          lineUserId: data.lineUserId,
          message: 'æ‚¨çš„ Ultra Advisor å¤©æ•¸å·²ç”¨å®Œï¼Œé€²å…¥ 3 å¤©å¯¬é™æœŸã€‚',
        });
      }
    }
    
    // è™•ç†å¯¬é™æœŸç”¨æˆ¶
    const graceUsers = await db.collection('users')
      .where('primaryTierId', '==', 'grace')
      .get();
    
    for (const doc of graceUsers.docs) {
      const data = doc.data();
      const newGraceDays = (data.graceDaysRemaining || 0) - 1;
      
      if (newGraceDays <= 0) {
        batch.update(doc.ref, {
          primaryTierId: 'expired',
          graceDaysRemaining: 0,
        });
      } else {
        batch.update(doc.ref, {
          graceDaysRemaining: newGraceDays,
        });
      }
    }
    
    await batch.commit();
    
    // ç™¼é€ LINE é€šçŸ¥ï¼ˆéœ€è¦å¯¦ä½œ sendLineNotificationï¼‰
    for (const n of notifications) {
      await sendLineNotification(n.lineUserId, n.message);
    }
    
    console.log(`Daily deduction completed. Processed ${paidUsers.size} paid users.`);
    return null;
  });
```

### 5. redeemPointsï¼ˆé»æ•¸å…Œæ›ï¼‰

```javascript
// è§¸ç™¼ï¼šcallable
// è¼¸å…¥ï¼š{ itemId: "7days" }
// è¼¸å‡ºï¼š{ success: true, newPoints: 1000, newDays: 372 }

exports.redeemPoints = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'è«‹å…ˆç™»å…¥');
  }
  
  const userId = context.auth.uid;
  const { itemId } = data;
  
  // å…Œæ›é …ç›®å®šç¾©
  const redeemItems = {
    '7days': { points: 500, days: 7, name: 'å»¶é•· 7 å¤©' },
    '30days': { points: 1800, days: 30, name: 'å»¶é•· 30 å¤©' },
  };
  
  const item = redeemItems[itemId];
  if (!item) {
    throw new functions.https.HttpsError('invalid-argument', 'ç„¡æ•ˆçš„å…Œæ›é …ç›®');
  }
  
  const userDoc = await db.collection('users').doc(userId).get();
  const userData = userDoc.data();
  
  // æª¢æŸ¥é»æ•¸
  if ((userData.points?.current || 0) < item.points) {
    throw new functions.https.HttpsError('failed-precondition', 'é»æ•¸ä¸è¶³');
  }
  
  // åŸ·è¡Œå…Œæ›
  const newPoints = userData.points.current - item.points;
  const newDays = (userData.daysRemaining || 0) + item.days;
  
  // å¦‚æœæ˜¯ expired/graceï¼Œå‡ç´šç‚º paid
  let newTierId = userData.primaryTierId;
  if (['expired', 'grace', 'trial', 'referral_trial'].includes(newTierId)) {
    newTierId = 'paid';
  }
  
  await userDoc.ref.update({
    'points.current': newPoints,
    daysRemaining: newDays,
    primaryTierId: newTierId,
    graceDaysRemaining: 0,
    totalPointsSpent: admin.firestore.FieldValue.increment(item.points),
  });
  
  // è¨˜éŒ„
  await db.collection('pointsLedger').add({
    userId,
    type: 'spend',
    amount: -item.points,
    reason: `å…Œæ›ï¼š${item.name}`,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  await db.collection('redemptionOrders').add({
    userId,
    itemId,
    itemName: item.name,
    pointsCost: item.points,
    daysAdded: item.days,
    status: 'completed',
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
  });
  
  return { success: true, newPoints, newDays };
});
```

---

## ğŸ–¥ï¸ å‰ç«¯ä¿®æ”¹è¦æ ¼

### 1. UltraWarRoom.tsx - é¡¯ç¤ºå¤©æ•¸å’Œå‡ç´šæŒ‰éˆ•

```tsx
// åœ¨ ProfileCard å€å¡ŠåŠ å…¥

// é¡¯ç¤ºå‰©é¤˜å¤©æ•¸
{membership.tier === 'paid' && (
  <div className="text-center p-3 bg-green-900/30 rounded-xl">
    <p className="text-2xl font-black text-green-400">{user.daysRemaining}</p>
    <p className="text-xs text-slate-400">å‰©é¤˜å¤©æ•¸</p>
  </div>
)}

// é¡¯ç¤ºå‡ç´šæŒ‰éˆ•ï¼ˆè©¦ç”¨/éæœŸç”¨æˆ¶ï¼‰
{['trial', 'referral_trial', 'grace', 'expired'].includes(membership.tier) && (
  <div className="mt-4">
    {membership.tier === 'referral_trial' ? (
      <a 
        href="https://portaly.cc/ä½ çš„æŠ˜æ‰£é€£çµ" 
        target="_blank"
        className="block w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 
                   rounded-xl text-white font-bold text-center"
      >
        å‡ç´š 365 å¤© - $8,000ï¼ˆå·²æŠ˜ $999ï¼‰
      </a>
    ) : (
      <a 
        href="https://portaly.cc/ä½ çš„åŸåƒ¹é€£çµ" 
        target="_blank"
        className="block w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 
                   rounded-xl text-white font-bold text-center"
      >
        å‡ç´š 365 å¤© - $8,999
      </a>
    )}
    
    {membership.tier === 'trial' && (
      <p className="text-xs text-slate-500 mt-2 text-center">
        è©¦ç”¨å‰©é¤˜ {user.daysRemaining} å¤©
      </p>
    )}
    {membership.tier === 'grace' && (
      <p className="text-xs text-amber-400 mt-2 text-center">
        âš ï¸ å¯¬é™æœŸå‰©é¤˜ {user.graceDaysRemaining} å¤©
      </p>
    )}
  </div>
)}
```

### 2. Admin å¾Œå° - è™•ç†è¨‚å–®æŒ‰éˆ•

åœ¨ Users.jsx åŠ å…¥ã€Œè™•ç†è¨‚å–®ã€åŠŸèƒ½ï¼š

```jsx
// æ–°å¢ Modalï¼šè™•ç†ä»˜æ¬¾è¨‚å–®
const ProcessPaymentModal = ({ visible, onClose, onSuccess }) => {
  const [email, setEmail] = useState('');
  const [days, setDays] = useState(365);
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async () => {
    setLoading(true);
    try {
      const processPayment = httpsCallable(functions, 'processPayment');
      const result = await processPayment({ userEmail: email, days });
      message.success(`è™•ç†æˆåŠŸï¼ç”¨æˆ¶ç¾æœ‰ ${result.data.newDaysRemaining} å¤©`);
      onSuccess();
      onClose();
    } catch (err) {
      message.error(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Modal title="è™•ç†ä»˜æ¬¾è¨‚å–®" open={visible} onCancel={onClose} onOk={handleSubmit}>
      <Input 
        placeholder="ç”¨æˆ¶ Email" 
        value={email} 
        onChange={e => setEmail(e.target.value)} 
      />
      <Select value={days} onChange={setDays} className="w-full mt-4">
        <Option value={365}>365 å¤©ï¼ˆå¹´è¨‚é–±ï¼‰</Option>
        <Option value={30}>30 å¤©ï¼ˆæœˆè¨‚é–±ï¼‰</Option>
        <Option value={7}>7 å¤©ï¼ˆé€±è¨‚é–±ï¼‰</Option>
      </Select>
      <p className="text-gray-500 mt-2">
        ç³»çµ±å°‡è‡ªå‹•ï¼šå‡ç´šç‚º paid + åŠ å¤©æ•¸ + ç™¼æ”¾æ¨è–¦çå‹µï¼ˆå¦‚æœ‰ï¼‰
      </p>
    </Modal>
  );
};
```

---

## ğŸ“± LINE æ©Ÿå™¨äººä¿®æ”¹è¦æ ¼

### è¨»å†Šæµç¨‹å°è©±

```
ç‹€æ…‹æ©Ÿï¼š
IDLE â†’ WAIT_EMAIL â†’ WAIT_REFERRAL â†’ CREATING

---

[ç”¨æˆ¶åŠ å…¥/å‚³é€ä»»æ„è¨Šæ¯]
æ©Ÿå™¨äººï¼š
ã€ŒğŸ‘‹ æ­¡è¿ä¾†åˆ° Ultra Advisorï¼

æˆ‘æ˜¯å°å¹«æ‰‹ï¼Œå¹«æ‚¨å¿«é€Ÿå»ºç«‹å¸³è™Ÿã€‚
è«‹è¼¸å…¥æ‚¨çš„ Emailï¼šã€

ç‹€æ…‹ â†’ WAIT_EMAIL

---

[ç”¨æˆ¶è¼¸å…¥ Email]
é©—è­‰ Email æ ¼å¼
â”œâ”€ ç„¡æ•ˆ â†’ ã€ŒEmail æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°è¼¸å…¥ã€
â””â”€ æœ‰æ•ˆ â†’ 

æ©Ÿå™¨äººï¼š
ã€Œâœ… Email ç¢ºèªï¼štest@gmail.com

è«‹å•æœ‰æœ‹å‹çš„æ¨è–¦ç¢¼å—ï¼Ÿ
æœ‰çš„è©±è«‹è¼¸å…¥æ¨è–¦ç¢¼ï¼Œæ²’æœ‰è«‹è¼¸å…¥ã€ç„¡ã€ã€

ç‹€æ…‹ â†’ WAIT_REFERRAL

---

[ç”¨æˆ¶è¼¸å…¥æ¨è–¦ç¢¼æˆ–ã€Œç„¡ã€]
â”œâ”€ è¼¸å…¥ã€Œç„¡ã€â†’ tierId = trial
â””â”€ è¼¸å…¥æ¨è–¦ç¢¼ â†’ å‘¼å« validateReferralCode
   â”œâ”€ æœ‰æ•ˆ â†’ tierId = referral_trial
   â””â”€ ç„¡æ•ˆ â†’ 

æ©Ÿå™¨äººï¼šã€ŒâŒ æ¨è–¦ç¢¼ç„¡æ•ˆï¼Œå°‡ä»¥ä¸€èˆ¬è©¦ç”¨èº«åˆ†è¨»å†Šã€
tierId = trial

---

[å»ºç«‹å¸³è™Ÿ]
å‘¼å« createUserFromLine({ email, referralCode, lineUserId })

æ©Ÿå™¨äººï¼š
ã€ŒğŸ‰ å¸³è™Ÿå»ºç«‹æˆåŠŸï¼

ğŸ“§ Emailï¼štest@gmail.com
ğŸ”‘ å¯†ç¢¼ï¼šAb3kX9mNï¼ˆè«‹ç™»å…¥å¾Œä¿®æ”¹ï¼‰
â­ èº«åˆ†ï¼šè©¦ç”¨æœƒå“¡ï¼ˆ7å¤©å…è²»é«”é©—ï¼‰
${tierId === 'referral_trial' ? 'ğŸ è½‰ä»‹ç´¹å„ªæƒ ï¼šè³¼è²·æ™‚å¯äº«æŠ˜æ‰£ $999ï¼' : ''}

ğŸ‘‰ ç«‹å³ç™»å…¥ï¼šhttps://ultra-advisor.tw

æœ‰å•é¡Œéš¨æ™‚å•æˆ‘ï¼ã€

ç‹€æ…‹ â†’ IDLE
```

---

## ğŸ“‹ é–‹ç™¼ä»»å‹™æª¢æŸ¥æ¸…å–®

### Phase 1ï¼šæ ¸å¿ƒåŠŸèƒ½ ğŸ”´

- [ ] **1-1** Cloud Function: `validateReferralCode`
- [ ] **1-2** Cloud Function: `createUserFromLine`
- [ ] **1-3** Cloud Function: `processPayment`
- [ ] **1-4** LINE æ©Ÿå™¨äººï¼šåŠ å…¥æ¨è–¦ç¢¼è¨»å†Šæµç¨‹
- [ ] **1-5** Firestoreï¼šæ–°å¢ `referral_trial` åˆ° membershipTiers
- [ ] **1-6** å‰ç«¯ UltraWarRoomï¼šé¡¯ç¤ºå‰©é¤˜å¤©æ•¸
- [ ] **1-7** å‰ç«¯ UltraWarRoomï¼šæ ¹æ“šèº«åˆ†çµ„é¡¯ç¤ºä¸åŒä»˜æ¬¾é€£çµ
- [ ] **1-8** Admin å¾Œå°ï¼šæ–°å¢ã€Œè™•ç†è¨‚å–®ã€æŒ‰éˆ•/Modal

### Phase 2ï¼šè‡ªå‹•åŒ– ğŸŸ¡

- [ ] **2-1** Cloud Function: `deductDailyDays`ï¼ˆæ¯æ—¥æ‰£å¤©æ•¸ï¼‰
- [ ] **2-2** Cloud Function: `sendLineNotification`ï¼ˆLINE æ¨æ’­ï¼‰
- [ ] **2-3** åˆ°æœŸæé†’ï¼š30å¤©ã€7å¤©ã€0å¤©é€šçŸ¥

### Phase 3ï¼šé»æ•¸å•†åŸ ğŸŸ¢

- [ ] **3-1** Cloud Function: `redeemPoints`
- [ ] **3-2** å‰ç«¯ï¼šé»æ•¸å…Œæ›é é¢/Modal
- [ ] **3-3** Adminï¼šå…Œæ›å•†å“ç®¡ç†
- [ ] **3-4** Adminï¼šå…Œæ›è¨‚å–®åˆ—è¡¨

---

## ğŸ”— Portaly é€£çµè¨­å®š

| ç”¨é€” | åƒ¹æ ¼ | é€£çµ |
|------|------|------|
| åŸåƒ¹è³¼è²· | $8,999 | `https://portaly.cc/ä½ çš„åŸåƒ¹é€£çµ` |
| æŠ˜æ‰£è³¼è²· | $8,000 | `https://portaly.cc/ä½ çš„æŠ˜æ‰£é€£çµ`ï¼ˆä½¿ç”¨æŠ˜æ‰£ç¢¼ï¼‰ |

**æŠ˜æ‰£ç¢¼**ï¼šMiiroll7ï¼ˆæŠ˜ $999ï¼‰

---

## ğŸ“ çµ¦ VS Code Claude çš„é–‹ç™¼æŒ‡ä»¤

è¤‡è£½ä»¥ä¸‹å…§å®¹çµ¦ Claude Codeï¼š

```
è«‹å…ˆè®€å– CLAUDE.md äº†è§£å°ˆæ¡ˆèƒŒæ™¯ã€‚

æˆ‘è¦é–‹ç™¼ã€Œå¤©æ•¸åˆ¶æœƒå“¡ç³»çµ±ã€ï¼Œè¦æ ¼å¦‚ä¸‹ï¼š

ã€è³‡æ–™çµæ§‹è®Šæ›´ã€‘
users/{uid} æ–°å¢æ¬„ä½ï¼š
- daysRemaining: numberï¼ˆå‰©é¤˜å¤©æ•¸ï¼‰
- lastDayDeducted: stringï¼ˆä¸Šæ¬¡æ‰£å¤©æ•¸æ—¥æœŸï¼ŒYYYY-MM-DDï¼‰
- graceDaysRemaining: numberï¼ˆå¯¬é™æœŸå‰©é¤˜å¤©æ•¸ï¼‰
- referralRewardClaimed: booleanï¼ˆæ¨è–¦çå‹µæ˜¯å¦å·²é ˜ï¼‰

ã€æ–°å¢èº«åˆ†çµ„ã€‘
åœ¨ membershipTiers æ–°å¢ï¼š
- referral_trialï¼šè½‰ä»‹ç´¹è©¦ç”¨æœƒå“¡

ã€Cloud Functions é–‹ç™¼ã€‘
è«‹åœ¨ functions/index.js æ–°å¢ï¼š

1. validateReferralCode - é©—è­‰æ¨è–¦ç¢¼
2. processPayment - è™•ç†ä»˜æ¬¾ï¼ˆAdmin ç”¨ï¼‰
3. deductDailyDays - æ¯æ—¥æ‰£å¤©æ•¸ï¼ˆscheduledï¼‰
4. redeemPoints - é»æ•¸å…Œæ›å¤©æ•¸

ã€å‰ç«¯ä¿®æ”¹ã€‘
UltraWarRoom.tsxï¼š
1. é¡¯ç¤ºå‰©é¤˜å¤©æ•¸ï¼ˆpaid ç”¨æˆ¶ï¼‰
2. é¡¯ç¤ºå‡ç´šæŒ‰éˆ•ï¼ˆtrial/referral_trial/grace/expiredï¼‰
3. referral_trial é¡¯ç¤ºæŠ˜æ‰£åƒ¹ $8,000
4. å…¶ä»–é¡¯ç¤ºåŸåƒ¹ $8,999

ã€Admin ä¿®æ”¹ã€‘
Users.jsx æ–°å¢ã€Œè™•ç†è¨‚å–®ã€åŠŸèƒ½ï¼š
- è¼¸å…¥ç”¨æˆ¶ Email
- é¸æ“‡å¤©æ•¸ï¼ˆ365/30/7ï¼‰
- ä¸€éµå®Œæˆï¼šå‡ç´š paid + åŠ å¤©æ•¸ + ç™¼æ¨è–¦çå‹µ

è«‹é–‹å§‹é–‹ç™¼ï¼Œå…ˆå¾ Cloud Functions é–‹å§‹ã€‚
```
