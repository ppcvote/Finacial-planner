import React, { useState, useEffect } from 'react';
import {
  Table,
  Input,
  Button,
  Space,
  Tag,
  Modal,
  Form,
  InputNumber,
  message,
  Popconfirm,
  Card,
  Row,
  Col,
  Statistic,
  Select,
} from 'antd';
import {
  SearchOutlined,
  UserOutlined,
  DeleteOutlined,
  ClockCircleOutlined,
  EyeOutlined,
  DownloadOutlined,
  ReloadOutlined,
} from '@ant-design/icons';
import {
  collection,
  getDocs,
  doc,
  updateDoc,
  deleteDoc,
  Timestamp,
  query,
  where,
  orderBy,
} from 'firebase/firestore';
import { deleteUser as deleteAuthUser } from 'firebase/auth';
import { db } from '../firebase';
import dayjs from 'dayjs';

const { Search } = Input;
const { Option } = Select;

const Users = () => {
  const [users, setUsers] = useState([]);
  const [filteredUsers, setFilteredUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchText, setSearchText] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [selectedUser, setSelectedUser] = useState(null);
  const [detailModalVisible, setDetailModalVisible] = useState(false);
  const [extendModalVisible, setExtendModalVisible] = useState(false);
  const [stats, setStats] = useState({
    total: 0,
    trial: 0,
    paid: 0,
    expired: 0,
  });

  // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
  useEffect(() => {
    fetchUsers();
  }, []);

  // æœå°‹å’Œç¯©é¸
  useEffect(() => {
    let filtered = users;

    // æœå°‹
    if (searchText) {
      filtered = filtered.filter(
        (user) =>
          user.email.toLowerCase().includes(searchText.toLowerCase()) ||
          user.id.toLowerCase().includes(searchText.toLowerCase())
      );
    }

    // ç¯©é¸ç‹€æ…‹
    if (filterStatus !== 'all') {
      filtered = filtered.filter((user) => user.subscriptionStatus === filterStatus);
    }

    setFilteredUsers(filtered);
  }, [users, searchText, filterStatus]);

  const fetchUsers = async () => {
    setLoading(true);
    try {
      const usersQuery = query(
        collection(db, 'users'),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(usersQuery);

      const usersList = [];
      snapshot.forEach((doc) => {
        const data = doc.data();
        usersList.push({
          key: doc.id,
          id: doc.id,
          ...data,
        });
      });

      setUsers(usersList);
      setFilteredUsers(usersList);

      // è¨ˆç®—çµ±è¨ˆ
      const stats = {
        total: usersList.length,
        trial: usersList.filter((u) => u.subscriptionStatus === 'trial' && u.isActive).length,
        paid: usersList.filter((u) => u.subscriptionStatus === 'paid').length,
        expired: usersList.filter((u) => !u.isActive).length,
      };
      setStats(stats);

      message.success('ç”¨æˆ¶è³‡æ–™è¼‰å…¥æˆåŠŸ');
    } catch (error) {
      console.error('Error fetching users:', error);
      message.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—');
    } finally {
      setLoading(false);
    }
  };

  // å»¶é•·è©¦ç”¨
  const handleExtendTrial = async (values) => {
    try {
      const userRef = doc(db, 'users', selectedUser.id);
      const currentExpiry = selectedUser.trialExpiresAt;
      const newExpiry = Timestamp.fromMillis(
        currentExpiry.toMillis() + values.days * 24 * 60 * 60 * 1000
      );

      await updateDoc(userRef, {
        trialExpiresAt: newExpiry,
      });

      message.success(`å·²å»¶é•· ${values.days} å¤©è©¦ç”¨æœŸ`);
      setExtendModalVisible(false);
      fetchUsers(); // é‡æ–°è¼‰å…¥
    } catch (error) {
      console.error('Error extending trial:', error);
      message.error('å»¶é•·è©¦ç”¨æœŸå¤±æ•—');
    }
  };

  // åˆªé™¤ç”¨æˆ¶
  const handleDeleteUser = async (userId) => {
    try {
      // åˆªé™¤ Firestore è³‡æ–™
      await deleteDoc(doc(db, 'users', userId));

      message.success('ç”¨æˆ¶å·²åˆªé™¤');
      fetchUsers(); // é‡æ–°è¼‰å…¥
    } catch (error) {
      console.error('Error deleting user:', error);
      message.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—');
    }
  };

  // å°å‡ºç”¨æˆ¶è³‡æ–™
  const handleExport = () => {
    try {
      const csvContent = [
        ['Email', 'UID', 'ç‹€æ…‹', 'è¨»å†Šæ™‚é–“', 'åˆ°æœŸæ™‚é–“', 'LINE ID'].join(','),
        ...filteredUsers.map((user) =>
          [
            user.email,
            user.id,
            user.subscriptionStatus,
            user.createdAt ? dayjs(user.createdAt.toDate()).format('YYYY-MM-DD HH:mm') : '',
            user.trialExpiresAt ? dayjs(user.trialExpiresAt.toDate()).format('YYYY-MM-DD HH:mm') : '',
            user.lineUserId || '',
          ].join(',')
        ),
      ].join('\n');

      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `users_${dayjs().format('YYYY-MM-DD')}.csv`;
      link.click();

      message.success('ç”¨æˆ¶è³‡æ–™å·²å°å‡º');
    } catch (error) {
      console.error('Error exporting users:', error);
      message.error('å°å‡ºå¤±æ•—');
    }
  };

  // è¡¨æ ¼æ¬„ä½
  const columns = [
    {
      title: 'Email',
      dataIndex: 'email',
      key: 'email',
      width: 250,
      ellipsis: true,
    },
    {
      title: 'ç‹€æ…‹',
      dataIndex: 'subscriptionStatus',
      key: 'status',
      width: 100,
      render: (status, record) => {
        const colors = {
          trial: record.isActive ? 'blue' : 'default',
          paid: 'green',
          expired: 'red',
        };
        const texts = {
          trial: record.isActive ? 'è©¦ç”¨ä¸­' : 'è©¦ç”¨çµæŸ',
          paid: 'å·²ä»˜è²»',
          expired: 'å·²éæœŸ',
        };
        return <Tag color={colors[status]}>{texts[status] || status}</Tag>;
      },
    },
    {
      title: 'è¨»å†Šæ™‚é–“',
      dataIndex: 'createdAt',
      key: 'createdAt',
      width: 180,
      render: (timestamp) => {
        if (!timestamp) return '-';
        return dayjs(timestamp.toDate()).format('YYYY-MM-DD HH:mm');
      },
    },
    {
      title: 'åˆ°æœŸæ™‚é–“',
      dataIndex: 'trialExpiresAt',
      key: 'expiresAt',
      width: 150,
      render: (timestamp) => {
        if (!timestamp) return '-';
        const daysLeft = Math.ceil((timestamp.toMillis() - Date.now()) / (1000 * 60 * 60 * 24));
        const color = daysLeft <= 3 ? 'red' : daysLeft <= 7 ? 'orange' : 'green';
        return (
          <span style={{ color }}>
            {daysLeft > 0 ? `${daysLeft} å¤©å¾Œ` : 'å·²éæœŸ'}
          </span>
        );
      },
    },
    {
      title: 'LINE ID',
      dataIndex: 'lineUserId',
      key: 'lineUserId',
      width: 150,
      ellipsis: true,
      render: (lineUserId) => lineUserId || '-',
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 200,
      fixed: 'right',
      render: (_, record) => (
        <Space size="small">
          <Button
            type="link"
            icon={<EyeOutlined />}
            onClick={() => {
              setSelectedUser(record);
              setDetailModalVisible(true);
            }}
          >
            è©³æƒ…
          </Button>
          <Button
            type="link"
            icon={<ClockCircleOutlined />}
            onClick={() => {
              setSelectedUser(record);
              setExtendModalVisible(true);
            }}
          >
            å»¶é•·
          </Button>
          <Popconfirm
            title="ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶å—ï¼Ÿ"
            description="æ­¤æ“ä½œç„¡æ³•å¾©åŸ"
            onConfirm={() => handleDeleteUser(record.id)}
            okText="ç¢ºå®š"
            cancelText="å–æ¶ˆ"
          >
            <Button type="link" danger icon={<DeleteOutlined />}>
              åˆªé™¤
            </Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h1>

      {/* çµ±è¨ˆå¡ç‰‡ */}
      <Row gutter={[16, 16]} className="mb-6">
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="ç¸½ç”¨æˆ¶æ•¸"
              value={stats.total}
              prefix={<UserOutlined />}
              valueStyle={{ color: '#3b82f6' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="è©¦ç”¨ä¸­"
              value={stats.trial}
              valueStyle={{ color: '#10b981' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="å·²ä»˜è²»"
              value={stats.paid}
              valueStyle={{ color: '#8b5cf6' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} lg={6}>
          <Card>
            <Statistic
              title="å·²éæœŸ"
              value={stats.expired}
              valueStyle={{ color: '#ef4444' }}
            />
          </Card>
        </Col>
      </Row>

      {/* æœå°‹å’Œç¯©é¸ */}
      <Card className="mb-6">
        <Space className="w-full" direction="vertical" size="middle">
          <Row gutter={16}>
            <Col xs={24} md={12}>
              <Search
                placeholder="æœå°‹ Email æˆ– UID"
                allowClear
                enterButton={<SearchOutlined />}
                size="large"
                onSearch={setSearchText}
                onChange={(e) => setSearchText(e.target.value)}
              />
            </Col>
            <Col xs={24} md={12}>
              <Space>
                <Select
                  value={filterStatus}
                  onChange={setFilterStatus}
                  style={{ width: 150 }}
                  size="large"
                >
                  <Option value="all">å…¨éƒ¨ç‹€æ…‹</Option>
                  <Option value="trial">è©¦ç”¨ä¸­</Option>
                  <Option value="paid">å·²ä»˜è²»</Option>
                </Select>
                <Button
                  icon={<ReloadOutlined />}
                  onClick={fetchUsers}
                  size="large"
                >
                  é‡æ–°è¼‰å…¥
                </Button>
                <Button
                  icon={<DownloadOutlined />}
                  onClick={handleExport}
                  size="large"
                >
                  å°å‡º CSV
                </Button>
              </Space>
            </Col>
          </Row>
        </Space>
      </Card>

      {/* ç”¨æˆ¶è¡¨æ ¼ */}
      <Card>
        <Table
          columns={columns}
          dataSource={filteredUsers}
          loading={loading}
          scroll={{ x: 1200 }}
          pagination={{
            pageSize: 10,
            showSizeChanger: true,
            showTotal: (total) => `å…± ${total} å€‹ç”¨æˆ¶`,
          }}
        />
      </Card>

      {/* ç”¨æˆ¶è©³æƒ… Modal */}
      <Modal
        title="ğŸ‘¤ ç”¨æˆ¶è©³æƒ…"
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={[
          <Button key="close" onClick={() => setDetailModalVisible(false)}>
            é—œé–‰
          </Button>,
        ]}
        width={600}
      >
        {selectedUser && (
          <Space direction="vertical" size="middle" className="w-full">
            <div>
              <strong>ğŸ“§ Emailï¼š</strong>
              <span>{selectedUser.email}</span>
            </div>
            <div>
              <strong>ğŸ†” UIDï¼š</strong>
              <span className="text-xs text-gray-500">{selectedUser.id}</span>
            </div>
            <div>
              <strong>ğŸ“… è¨»å†Šæ™‚é–“ï¼š</strong>
              <span>
                {selectedUser.createdAt
                  ? dayjs(selectedUser.createdAt.toDate()).format('YYYY-MM-DD HH:mm:ss')
                  : '-'}
              </span>
            </div>
            <div>
              <strong>â° è©¦ç”¨åˆ°æœŸï¼š</strong>
              <span>
                {selectedUser.trialExpiresAt
                  ? dayjs(selectedUser.trialExpiresAt.toDate()).format('YYYY-MM-DD HH:mm:ss')
                  : '-'}
              </span>
            </div>
            <div>
              <strong>ğŸ“± LINE User IDï¼š</strong>
              <span className="text-xs text-gray-500">{selectedUser.lineUserId || '-'}</span>
            </div>
            <div>
              <strong>ğŸ“Š ç‹€æ…‹ï¼š</strong>
              <Tag
                color={
                  selectedUser.subscriptionStatus === 'trial'
                    ? 'blue'
                    : selectedUser.subscriptionStatus === 'paid'
                    ? 'green'
                    : 'red'
                }
              >
                {selectedUser.subscriptionStatus === 'trial'
                  ? 'è©¦ç”¨ä¸­'
                  : selectedUser.subscriptionStatus === 'paid'
                  ? 'å·²ä»˜è²»'
                  : 'å·²éæœŸ'}
              </Tag>
            </div>
          </Space>
        )}
      </Modal>

      {/* å»¶é•·è©¦ç”¨ Modal */}
      <Modal
        title="â±ï¸ å»¶é•·è©¦ç”¨æœŸ"
        open={extendModalVisible}
        onCancel={() => setExtendModalVisible(false)}
        footer={null}
      >
        <Form onFinish={handleExtendTrial} layout="vertical">
          <Form.Item
            name="days"
            label="å»¶é•·å¤©æ•¸"
            rules={[{ required: true, message: 'è«‹è¼¸å…¥å»¶é•·å¤©æ•¸' }]}
            initialValue={7}
          >
            <InputNumber min={1} max={365} style={{ width: '100%' }} />
          </Form.Item>
          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                ç¢ºå®šå»¶é•·
              </Button>
              <Button onClick={() => setExtendModalVisible(false)}>å–æ¶ˆ</Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default Users;
