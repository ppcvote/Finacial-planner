# 🛍️ UA 商城系統規格書

> 版本：v1.0
> 
> 
> **日期**：2026-01-14
> 
> **狀態**：待開發
> 

---

## 1. 系統概述

### 1.1 目標

建立 UA 點數兌換商城，讓用戶可用累積的 UA 點數兌換周邊商品或服務，提升黏著度與品牌認同。

### 1.2 核心原則

- 🎁 **贈品只送不賣**：商品無法用現金購買
- 💎 **點數無現金價值**：不可轉讓、不可退換現金
- 🔥 **稀缺性**：限量商品製造緊迫感

---

## 2. 前台規格

### 2.1 入口位置

- **位置**：UA 推薦引擎卡片內
- **按鈕**：「🛍️ 進入 UA 商城」

### 2.2 商城入口 UI

```
┌─────────────────────────────────────────────────┐
│  🎯 UA 推薦引擎                                  │
│  ┌─────────────────────────────────────────┐   │
│  │ 你的推薦碼：ULTRA-WANG-8888             │   │
│  │ [複製] [分享]                            │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  💎 目前點數：1,250 UA                          │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │     🛍️ 進入 UA 商城                      │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘

```

### 2.3 商城頁面（展開式）

點擊「進入 UA 商城」後，展開商城面板：

```
┌─────────────────────────────────────────────────────────────┐
│  🛍️ UA 商城                               💎 1,250 UA  [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   [圖片]    │  │   [圖片]    │  │   [圖片]    │        │
│  │             │  │             │  │             │        │
│  │ Ultra 戰袍  │  │ 戰情室馬克杯│  │ 經典棒球帽  │        │
│  │ 2,000 UA   │  │ 1,500 UA   │  │ 1,800 UA   │        │
│  │ 庫存：15   │  │ 庫存：8    │  │ 🔥 剩3件   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   [圖片]    │  │   [圖片]    │  │   [圖片]    │        │
│  │             │  │             │  │             │        │
│  │ 質感保溫杯  │  │ 延長訂閱1月 │  │  敬請期待   │        │
│  │ 3,000 UA   │  │ 1,000 UA   │  │    ???     │        │
│  │ 庫存：20   │  │ 無限       │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘

```

### 2.4 商品詳情 Modal

點擊商品卡片後顯示：

```
┌─────────────────────────────────────────────────┐
│  Ultra 戰袍 T-Shirt                       [X]   │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │                                         │   │
│  │              [商品大圖]                  │   │
│  │                                         │   │
│  │     ○  ○  ○  ○  （多圖切換）            │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  💎 2,000 UA                                    │
│  📦 庫存：15 件                                 │
│                                                 │
│  ─────────────────────────────────────────────  │
│                                                 │
│  商品說明：                                      │
│  經典黑色 T-Shirt，胸前印有 Ultra Advisor       │
│  Logo，100% 純棉材質，穿上就是戰友！            │
│                                                 │
│  尺寸：[S] [M] [L] [XL]                        │
│                                                 │
│  ─────────────────────────────────────────────  │
│                                                 │
│  你的點數：1,250 UA                             │
│  兌換所需：2,000 UA                             │
│  還差：750 UA                                   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │  ❌ 點數不足，繼續努力！                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  💡 完成任務可快速獲得點數喔！                   │
│                                                 │
└─────────────────────────────────────────────────┘

```

**點數足夠時**：

```
│  你的點數：2,500 UA                             │
│  兌換所需：2,000 UA                             │
│  兌換後剩餘：500 UA                             │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │       🎁 確認兌換（2,000 UA）            │   │
│  └─────────────────────────────────────────┘   │

```

### 2.5 兌換流程

```
┌─────────────────────────────────────────┐
│ 1. 點擊「確認兌換」                       │
└────────────────┬────────────────────────┘
                 ▼
┌─────────────────────────────────────────┐
│ 2. 確認 Modal                            │
│    「確定要用 2,000 UA 兌換              │
│     Ultra 戰袍 T-Shirt (L) 嗎？」        │
│    [取消] [確認兌換]                     │
└────────────────┬────────────────────────┘
                 ▼
┌─────────────────────────────────────────┐
│ 3. 填寫收件資訊（實體商品）              │
│    - 收件人姓名                          │
│    - 手機號碼                            │
│    - 收件地址                            │
│    [提交]                                │
└────────────────┬────────────────────────┘
                 ▼
┌─────────────────────────────────────────┐
│ 4. 兌換成功                              │
│    「🎉 兌換成功！」                     │
│    「我們會在 7 個工作天內寄出」         │
│    [查看訂單]                            │
└─────────────────────────────────────────┘

```

### 2.6 我的兌換紀錄

在商城頁面新增 Tab 或按鈕：

```
┌─────────────────────────────────────────────────┐
│  📦 我的兌換紀錄                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ Ultra 戰袍 T-Shirt (L)                  │   │
│  │ 兌換時間：2026/01/14                    │   │
│  │ 狀態：🚚 已出貨                         │   │
│  │ 追蹤號碼：7654321                       │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 延長訂閱 1 個月                         │   │
│  │ 兌換時間：2026/01/10                    │   │
│  │ 狀態：✅ 已完成                         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘

```

---

## 3. 後台規格

### 3.1 商品管理頁面

**路由**：`/admin/store`（確認現有頁面）

### 3.2 商品列表

```
┌────────────────────────────────────────────────────────────────────┐
│  🛍️ 商品管理                                    [+ 新增商品]       │
├────────────────────────────────────────────────────────────────────┤
│  # │ 圖片 │ 商品名稱       │ 點數  │ 庫存  │ 已兌換 │ 狀態 │ 操作  │
│────────────────────────────────────────────────────────────────────│
│  1 │ 🖼️  │ Ultra 戰袍     │ 2000 │ 15   │ 5     │ 🟢  │ [編輯]│
│  2 │ 🖼️  │ 戰情室馬克杯   │ 1500 │ 8    │ 12    │ 🟢  │ [編輯]│
│  3 │ 🖼️  │ 經典棒球帽     │ 1800 │ 3    │ 7     │ 🟢  │ [編輯]│
│  4 │ 🖼️  │ 質感保溫杯     │ 3000 │ 20   │ 0     │ 🟢  │ [編輯]│
│  5 │ 🖼️  │ 延長訂閱1月    │ 1000 │ ∞    │ 23    │ 🟢  │ [編輯]│
└────────────────────────────────────────────────────────────────────┘

```

### 3.3 新增/編輯商品 Modal

```
┌─────────────────────────────────────────────────┐
│  ✏️ 編輯商品                              [X]   │
├─────────────────────────────────────────────────┤
│                                                 │
│  商品名稱 *                                     │
│  ┌─────────────────────────────────────────┐   │
│  │ Ultra 戰袍 T-Shirt                      │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  商品說明                                       │
│  ┌─────────────────────────────────────────┐   │
│  │ 經典黑色 T-Shirt，胸前印有...           │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  商品圖片                                       │
│  ┌──────┐ ┌──────┐ ┌──────┐ [+ 上傳]       │
│  │ 🖼️  │ │ 🖼️  │ │ 🖼️  │                 │
│  └──────┘ └──────┘ └──────┘                 │
│                                                 │
│  商品類型 *                                     │
│  ┌─────────────────────────────────────────┐   │
│  │ ○ 實體商品（需填寫收件地址）             │   │
│  │ ● 虛擬商品（系統自動處理）               │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  兌換點數 *            庫存數量                 │
│  ┌──────────┐          ┌──────────────────┐   │
│  │ 2000     │          │ 15 (0=無限)      │   │
│  └──────────┘          └──────────────────┘   │
│                                                 │
│  規格選項（選填，逗號分隔）                      │
│  ┌─────────────────────────────────────────┐   │
│  │ S, M, L, XL                             │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  排序                 啟用狀態                  │
│  ┌──────────┐        [✅] 上架此商品           │
│  │ 1        │                                  │
│  └──────────┘                                  │
│                                                 │
├─────────────────────────────────────────────────┤
│                    [取消]  [儲存]               │
└─────────────────────────────────────────────────┘

```

### 3.4 兌換訂單管理

**路由**：`/admin/orders`

```
┌────────────────────────────────────────────────────────────────────────────┐
│  📦 兌換訂單                                                               │
├────────────────────────────────────────────────────────────────────────────┤
│  篩選：[全部 ▼] [待處理] [已出貨] [已完成]                                 │
├────────────────────────────────────────────────────────────────────────────┤
│  訂單編號   │ 用戶        │ 商品          │ 點數  │ 狀態     │ 時間       │ 操作      │
│────────────────────────────────────────────────────────────────────────────│
│  ORD-001  │ 王小明      │ Ultra戰袍(L)  │ 2000 │ ⏳待處理 │ 01/14 10:23│ [處理]    │
│  ORD-002  │ 李大華      │ 延長訂閱1月   │ 1000 │ ✅已完成 │ 01/13 18:42│ [查看]    │
│  ORD-003  │ 陳美玲      │ 馬克杯        │ 1500 │ 🚚已出貨 │ 01/12 09:15│ [更新]    │
└────────────────────────────────────────────────────────────────────────────┘

```

### 3.5 訂單處理 Modal

```
┌─────────────────────────────────────────────────┐
│  📦 訂單處理 #ORD-001                     [X]   │
├─────────────────────────────────────────────────┤
│                                                 │
│  商品：Ultra 戰袍 T-Shirt (L)                   │
│  點數：2,000 UA                                 │
│  兌換時間：2026/01/14 10:23                     │
│                                                 │
│  ─────────── 用戶資訊 ───────────              │
│  用戶：王小明 (wang@example.com)                │
│                                                 │
│  ─────────── 收件資訊 ───────────              │
│  收件人：王小明                                  │
│  手機：0912-345-678                             │
│  地址：台北市信義區信義路五段7號                 │
│                                                 │
│  ─────────── 訂單狀態 ───────────              │
│  ┌─────────────────────────────────────────┐   │
│  │ ○ 待處理                                 │   │
│  │ ○ 處理中                                 │   │
│  │ ○ 已出貨                                 │   │
│  │ ○ 已完成                                 │   │
│  │ ○ 已取消                                 │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  物流追蹤號碼（選填）                            │
│  ┌─────────────────────────────────────────┐   │
│  │ 7654321                                  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  備註                                           │
│  ┌─────────────────────────────────────────┐   │
│  │                                          │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
├─────────────────────────────────────────────────┤
│                    [取消]  [更新狀態]           │
└─────────────────────────────────────────────────┘

```

---

## 4. 資料結構

### 4.1 Firestore Collections

### `storeItems/{itemId}` - 商品定義

```tsx
interface StoreItem {
  id: string;
  name: string;                  // 商品名稱
  description: string;           // 商品說明
  images: string[];              // 圖片 URL 陣列

  type: 'physical' | 'virtual';  // 實體/虛擬商品
  points: number;                // 兌換所需點數
  stock: number;                 // 庫存（0 = 無限）

  variants?: string[];           // 規格選項（如尺寸）

  order: number;                 // 排序
  isActive: boolean;             // 是否上架

  // 虛擬商品專用
  virtualAction?: 'extend_subscription';  // 虛擬商品動作
  virtualValue?: number;                   // 動作參數（如延長天數）

  // 統計
  totalRedeemed: number;         // 累計兌換數

  createdAt: Timestamp;
  updatedAt: Timestamp;
}

```

### `orders/{orderId}` - 兌換訂單

```tsx
interface Order {
  id: string;
  orderNumber: string;           // 訂單編號（ORD-XXX）

  // 用戶資訊
  uid: string;
  userEmail: string;
  userName: string;

  // 商品資訊
  itemId: string;
  itemName: string;
  itemImage: string;
  variant?: string;              // 選擇的規格
  pointsSpent: number;

  // 收件資訊（實體商品）
  shippingInfo?: {
    name: string;
    phone: string;
    address: string;
  };

  // 狀態
  status: 'pending' | 'processing' | 'shipped' | 'completed' | 'cancelled';
  trackingNumber?: string;       // 物流追蹤號

  // 備註
  adminNote?: string;

  createdAt: Timestamp;
  updatedAt: Timestamp;
  completedAt?: Timestamp;
}

```

### `pointsLedger/{transactionId}` - 點數記錄（新增類型）

```tsx
interface PointsTransaction {
  uid: string;
  type: 'redeem';                // 兌換扣點
  orderId: string;
  itemName: string;
  amount: number;                // 負數（扣點）
  balanceAfter: number;
  createdAt: Timestamp;
}

```

---

## 5. Cloud Functions

### 5.1 redeemItem - 兌換商品

```jsx
exports.redeemItem = functions.https.onCall(async (data, context) => {
  // 1. 驗證登入
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', '請先登入');
  }

  const uid = context.auth.uid;
  const { itemId, variant, shippingInfo } = data;

  // 2. 取得商品資料
  const itemRef = admin.firestore().collection('storeItems').doc(itemId);
  const itemDoc = await itemRef.get();

  if (!itemDoc.exists || !itemDoc.data().isActive) {
    throw new functions.https.HttpsError('not-found', '商品不存在或已下架');
  }

  const item = itemDoc.data();

  // 3. 檢查庫存
  if (item.stock > 0 && item.stock < 1) {
    throw new functions.https.HttpsError('resource-exhausted', '商品已售罄');
  }

  // 4. 檢查點數
  const userRef = admin.firestore().collection('users').doc(uid);
  const userDoc = await userRef.get();
  const currentPoints = userDoc.data().points || 0;

  if (currentPoints < item.points) {
    throw new functions.https.HttpsError('failed-precondition', '點數不足');
  }

  // 5. 實體商品檢查收件資訊
  if (item.type === 'physical' && !shippingInfo) {
    throw new functions.https.HttpsError('invalid-argument', '請填寫收件資訊');
  }

  // 6. 執行交易
  const orderNumber = `ORD-${Date.now().toString(36).toUpperCase()}`;
  const newPoints = currentPoints - item.points;

  await admin.firestore().runTransaction(async (transaction) => {
    // 扣除點數
    transaction.update(userRef, { points: newPoints });

    // 扣除庫存
    if (item.stock > 0) {
      transaction.update(itemRef, {
        stock: admin.firestore.FieldValue.increment(-1),
        totalRedeemed: admin.firestore.FieldValue.increment(1)
      });
    } else {
      transaction.update(itemRef, {
        totalRedeemed: admin.firestore.FieldValue.increment(1)
      });
    }

    // 建立訂單
    const orderRef = admin.firestore().collection('orders').doc();
    transaction.set(orderRef, {
      id: orderRef.id,
      orderNumber: orderNumber,
      uid: uid,
      userEmail: userDoc.data().email,
      userName: userDoc.data().displayName || '',
      itemId: itemId,
      itemName: item.name,
      itemImage: item.images[0] || '',
      variant: variant || null,
      pointsSpent: item.points,
      shippingInfo: shippingInfo || null,
      status: item.type === 'virtual' ? 'completed' : 'pending',
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
      completedAt: item.type === 'virtual' ? admin.firestore.FieldValue.serverTimestamp() : null
    });

    // 記錄點數帳本
    const ledgerRef = admin.firestore().collection('pointsLedger').doc();
    transaction.set(ledgerRef, {
      uid: uid,
      type: 'redeem',
      orderId: orderRef.id,
      itemName: item.name,
      amount: -item.points,
      balanceAfter: newPoints,
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    });

    // 虛擬商品：執行對應動作
    if (item.type === 'virtual' && item.virtualAction === 'extend_subscription') {
      const currentEnd = userDoc.data().subscriptionEndDate?.toDate() || new Date();
      const newEnd = new Date(currentEnd);
      newEnd.setDate(newEnd.getDate() + (item.virtualValue || 30));

      transaction.update(userRef, {
        subscriptionEndDate: admin.firestore.Timestamp.fromDate(newEnd),
        subscriptionStatus: 'active'
      });
    }
  });

  return {
    success: true,
    orderNumber: orderNumber,
    message: '🎉 兌換成功！'
  };
});

```

---

## 6. UA 點數定價策略

### 6.1 獲取點數方式

| 行為 | 點數 | 頻率 |
| --- | --- | --- |
| 推薦好友註冊 | +100 | 每次 |
| 被推薦註冊（新用戶） | +50 | 一次 |
| 每日登入 | +5 | 每日 |
| 連續登入 7 天 | +50 | 每週 |
| 連續登入 30 天 | +200 | 每月 |
| 完成新手任務 | +15~30 | 一次 |
| 完成社交任務 | +20~25 | 一次 |
| 完成習慣任務 | +15~30 | 一次 |
| 提交功能建議 | +10 | 每次 |

### 6.2 商品定價建議

| 商品 | 成本估計 | 建議點數 | 說明 |
| --- | --- | --- | --- |
| 延長訂閱 1 月 | ~$583 | 1,000 UA | 高價值，鼓勵持續使用 |
| 品牌 T-Shirt | ~$300 | 2,000 UA | 約 20 次推薦可得 |
| 馬克杯 | ~$200 | 1,500 UA | 中等難度 |
| 棒球帽 | ~$250 | 1,800 UA | 中等難度 |
| 質感保溫杯 | ~$400 | 3,000 UA | 高階獎品 |

### 6.3 點數價值換算

```
假設：
- 年訂閱 $6,999
- 延長 1 月 = $583
- 1,000 UA = $583

每 1 UA ≈ $0.58 價值

```

### 6.4 用戶累積路徑範例

| 用戶類型 | 月累積點數 | 達成 2,000 UA 所需 |
| --- | --- | --- |
| 低活躍 | ~150 UA | 約 13 個月 |
| 中活躍 | ~400 UA | 約 5 個月 |
| 高活躍（含推薦） | ~1,000 UA | 約 2 個月 |

---

## 7. 前台元件規格

### 7.1 StoreModal.tsx

**位置**：`src/components/StoreModal.tsx`

**功能**：

1. 商品列表（Grid 排列）
2. 商品詳情彈窗
3. 兌換流程
4. 我的訂單紀錄

### 7.2 Props

```tsx
interface StoreModalProps {
  isOpen: boolean;
  onClose: () => void;
  userPoints: number;
}

```

---

## 8. 後台頁面確認

**請確認現有後台是否已有以下頁面**：

- [ ]  `/admin/store` - 商品管理
- [ ]  `/admin/orders` - 訂單管理

如果已存在，請確認：

- [ ]  商品是否可新增/編輯
- [ ]  資料結構是否與本規格相符
- [ ]  是否有串接前台

---

## 9. 測試檢查清單

### 前台

- [ ]  商城按鈕正確顯示
- [ ]  商品列表正確載入
- [ ]  商品詳情正確顯示
- [ ]  點數不足時按鈕禁用
- [ ]  兌換流程完整
- [ ]  實體商品填寫收件資訊
- [ ]  虛擬商品自動完成
- [ ]  訂單紀錄正確顯示

### 後台

- [ ]  商品 CRUD 功能
- [ ]  圖片上傳功能
- [ ]  訂單列表正確
- [ ]  訂單狀態更新
- [ ]  物流追蹤號填寫

### 點數

- [ ]  兌換後點數正確扣除
- [ ]  pointsLedger 正確記錄
- [ ]  庫存正確扣減

---

## 10. 版本紀錄

| 版本 | 日期 | 變更內容 |
| --- | --- | --- |
| v1.0 | 2026-01-14 | 初版規格書 |

---

**此規格書供 Claude Code 開發參考，如有疑問請回報討論。**