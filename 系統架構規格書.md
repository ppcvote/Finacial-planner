# Ultra Advisor 系統架構文件

> 最後更新：2026-01-15

---

## 目錄

1. [專案概述](#1-專案概述)
2. [目錄結構](#2-目錄結構)
3. [前端架構](#3-前端架構)
4. [Cloud Functions](#4-cloud-functions)
5. [Admin 後台](#5-admin-後台)
6. [Firestore 資料結構](#6-firestore-資料結構)
7. [數據流向](#7-數據流向)
8. [關鍵邏輯實現](#8-關鍵邏輯實現)
9. [API 文檔](#9-api-文檔)
10. [部署指南](#10-部署指南)

---

## 1. 專案概述

Ultra Advisor 是一個 SaaS 平台，為台灣財務顧問提供 18 種數據視覺化工具。

### 技術棧
- **前端**：React + TypeScript + Vite + Tailwind CSS
- **後台**：React + Ant Design
- **資料庫**：Firebase Firestore
- **認證**：Firebase Authentication
- **後端**：Firebase Cloud Functions (Node.js 20)
- **部署**：Vercel (前端) + Firebase Hosting (後台)

### 網址
- 前端：https://ultra-advisor.tw
- 後台：https://admin.ultra-advisor.tw/secret-admin-ultra-2026
- LINE 官方帳號：https://lin.ee/RFE8A5A

---

## 2. 目錄結構

```
c:\Users\User\financial-planner\
├── src/                           # 前端主程式
│   ├── App.tsx                    # 主應用程式（路由、狀態管理）
│   ├── firebase.ts                # Firebase 設定
│   ├── main.tsx                   # React 入口
│   ├── index.css                  # 全域樣式
│   ├── components/                # React 元件
│   │   ├── 工具元件（18 個）
│   │   ├── 報表元件
│   │   ├── 核心功能元件
│   │   └── auth/                  # 認證相關
│   ├── hooks/                     # React Custom Hooks
│   │   ├── usePoints.ts           # 點數系統
│   │   ├── useMembership.ts       # 會員權限
│   │   └── useMissions.ts         # 任務系統
│   ├── pages/                     # 特殊路由頁面
│   │   ├── LiffRegister.tsx       # LINE LIFF 註冊
│   │   └── PublicCalculator.tsx   # 公開計算機
│   └── data/
│       └── fundData.ts            # 基金數據庫
│
├── functions/                     # Cloud Functions
│   ├── index.js                   # 主入口（3,000+ 行）
│   └── package.json
│
├── admin/                         # Admin 後台
│   ├── src/
│   │   ├── App.jsx
│   │   ├── firebase.js
│   │   ├── components/
│   │   │   └── Layout.jsx
│   │   └── pages/
│   │       ├── Dashboard.jsx
│   │       ├── Users.jsx
│   │       ├── LineBotEditor.jsx
│   │       └── membership/        # 會員系統管理
│   └── dist/
│
├── public/                        # 靜態資源
│   └── manifest.json              # PWA 設定
│
├── CLAUDE.md                      # AI 開發指南
├── ARCHITECTURE.md                # 本文件
└── UltraAdvisor更新日誌           # 更新紀錄
```

---

## 3. 前端架構

### 3.1 主應用流程 (App.tsx)

```
用戶訪問 → 檢查登入狀態 → 未登入(顯示登陸頁) → 登入成功
         → 載入會員資料 → 選擇客戶 → 載入客戶數據 → 使用工具
```

**路由管理**（SPA，使用 history.pushState）：
| 路徑 | 頁面 |
|------|------|
| `/` | 主應用 |
| `/login` | 登入頁 |
| `/signup-secret` | 秘密註冊頁 |
| `/calculator` | 公開計算機 |
| `/liff/register` | LINE LIFF 註冊 |

**核心狀態**：
```typescript
user                    // Firebase Auth 用戶
currentClient           // 選中的客戶
activeTab               // 當前工具 ID
membership              // 會員權限信息
pointsNotification      // 點數獲得通知
isPointsDashboardOpen   // 點數儀表板顯示
```

### 3.2 工具系統（18 個工具）

| 分類 | 工具 ID | 元件名 | 免費 | 說明 |
|------|---------|--------|------|------|
| 觀念診斷 | `golden_safe` | GoldenSafeVault | ❌ | 黃金保險箱 |
| 觀念診斷 | `market_data` | MarketDataZone | ❌ | 市場數據 |
| 觀念診斷 | `fund_machine` | FundTimeMachine | ❌ | 基金時光機 |
| 觀念診斷 | `free_dashboard` | FreeDashboardTool | ❌ | 自由組合 |
| 創富 | `gift` | MillionDollarGiftTool | ❌ | 百萬禮物 |
| 創富 | `estate` | FinancialRealEstateTool | ✅ | 金融房產 |
| 創富 | `student` | StudentLoanTool | ❌ | 學貸活化 |
| 創富 | `super_active` | SuperActiveSavingTool | ❌ | 超積極存錢 |
| 守富 | `reservoir` | BigSmallReservoirTool | ✅ | 大小水庫 |
| 守富 | `car` | CarReplacementTool | ❌ | 五年換車 |
| 守富 | `pension` | LaborPensionTool | ❌ | 退休缺口 |
| 傳富 | `tax` | TaxPlannerTool | ✅ | 稅務傳承 |

**權限控制邏輯**：
```typescript
FREE_TOOLS = ['estate', 'reservoir', 'tax']

canAccessTool(toolId): boolean {
  if (tier === 'founder' || tier === 'paid') return true
  return FREE_TOOLS.includes(toolId)
}
```

### 3.3 Hooks 系統

#### usePoints.ts - 點數系統
```typescript
// API 方法
triggerDailyLogin()         // 每日登入獎勵
triggerToolUse(toolName)    // 工具使用獎勵
triggerFirstClient()        // 首位客戶獎勵
useReferralCode(code)       // 使用推薦碼
updateMyReferralCode(code)  // 自訂推薦碼
getPointsSummary()          // 取得點數摘要
```

#### useMembership.ts - 會員權限
```typescript
// 返回值
{
  tier: 'founder' | 'paid' | 'trial' | 'grace' | 'expired',
  tierName: string,
  points: number,
  daysRemaining: number,
  referralCode: string,
  referralCount: number,
  canAccessTool(id): boolean
}
```

#### useMissions.ts - 任務系統
```typescript
// 任務結構
interface Mission {
  id: string
  title: string
  points: number
  category: 'onboarding' | 'social' | 'habit' | 'daily'
  linkType: 'modal' | 'internal' | 'external' | 'pwa'
  verificationType: 'auto' | 'manual'
  verificationField?: string
  repeatType: 'once' | 'daily'
  isCompleted?: boolean
  isCompletedToday?: boolean
}

// API 方法
fetchMissions()              // 取得任務列表
completeMission(missionId)   // 完成任務
checkAutoVerification()      // 檢查自動驗證
```

---

## 4. Cloud Functions

### 4.1 端點列表

#### 用戶相關
| 函數名 | 類型 | 說明 |
|--------|------|------|
| `onDailyLogin` | callable | 每日登入獎勵 (+5 UA) |
| `onToolUse` | callable | 工具使用獎勵 (+10 UA) |
| `onFirstClient` | callable | 首位客戶獎勵 (+50 UA) |
| `processReferral` | callable | 處理推薦碼 |
| `updateReferralCode` | callable | 自訂推薦碼 |
| `getUserPointsSummary` | callable | 取得點數摘要 |

#### 任務系統
| 函數名 | 類型 | 說明 |
|--------|------|------|
| `getMissions` | callable | 取得任務列表 |
| `completeMission` | callable | 完成任務並發放點數 |
| `initMissionsCallable` | callable | 初始化預設任務 |

#### 會員系統（Admin 用）
| 函數名 | 類型 | 說明 |
|--------|------|------|
| `processPayment` | callable | 處理付款（天數制） |
| `adminResetPassword` | callable | 重設用戶密碼 |
| `validateReferralCode` | callable | 驗證推薦碼 |

#### LINE Bot
| 函數名 | 類型 | 說明 |
|--------|------|------|
| `lineWebhook` | https | LINE Webhook 端點 |

### 4.2 核心邏輯

#### 點數發放流程
```javascript
awardPoints(userId, actionId, reason)
├── 檢查限制（每日/每週/總計）
├── 取得用戶倍率
├── 計算最終點數 = basePoints × multiplier
├── 事務性寫入：
│   ├── pointsLedger/{newDoc}  // 交易記錄
│   └── users/{userId}         // 更新餘額
└── 返回 { success, points, newBalance }
```

#### LINE Bot 註冊流程
```javascript
createTrialAccount(email, lineUserId, referralCode)
├── 檢查速率限制（30 分鐘冷卻）
├── 驗證 Email 唯一性
├── 驗證推薦碼（如有）
├── 生成隨機密碼
├── 建立 Firebase Auth 用戶
├── 建立 Firestore 文檔
│   ├── primaryTierId: 'trial' 或 'referral_trial'
│   ├── daysRemaining: 7
│   ├── referralCode: 自動生成
│   └── referredBy: 推薦人 UID（如有）
├── 發送 LINE Flex Message
└── 返回 { success, uid, tierId }
```

---

## 5. Admin 後台

### 5.1 頁面結構

| 頁面 | 路徑 | 說明 |
|------|------|------|
| Dashboard | `/` | 統計儀表板 |
| Users | `/users` | 用戶管理 |
| LineBotEditor | `/line-bot` | LINE Bot 設定 |
| SiteEditor | `/site` | 網站內容管理 |

**會員系統 (/membership/)**：
| 頁面 | 說明 |
|------|------|
| MembershipTiers | 會員等級管理 |
| PointsRules | 點數規則設定 |
| PointsLedger | 點數交易記錄 |
| PaymentHistory | 付款歷史 |
| Referrals | 推薦系統管理 |
| Missions | 任務管理 |
| AuditLogs | 審計日誌 |

### 5.2 用戶管理核心功能

```javascript
// 身分組變更
changeMembership(user, tierId)

// 延長會員天數
extendMembership(user, days)

// 付款處理（天數 + 獎勵）
processPayment(userEmail, days, amount)

// 密碼重設
resetPassword(userEmail, newPassword)

// 孤立帳號清理
listOrphanAuthUsers()
deleteOrphanAuthUsers(uids)
```

---

## 6. Firestore 資料結構

### users/{uid}
```javascript
{
  // 基本資料
  email: string,
  displayName: string,
  photoURL: string,

  // 會員系統（天數制）
  primaryTierId: 'founder' | 'paid' | 'trial' | 'referral_trial' | 'grace' | 'expired',
  daysRemaining: number,
  graceDaysRemaining: number,
  membershipExpiresAt: Timestamp,

  // 點數系統
  points: { current: number },
  totalPointsEarned: number,
  totalPointsSpent: number,
  totalPointsExpired: number,

  // 推薦系統
  referralCode: string,
  referredBy: string | null,
  referralCount: number,
  referralRewardClaimed: boolean,

  // 任務追蹤
  loginStreak: number,
  lastLoginDate: string,  // YYYY-MM-DD
  cheatSheetUsageCount: number,

  // LINE 整合
  lineUserId: string,

  // 時間戳
  createdAt: Timestamp,
  updatedAt: Timestamp,

  // 子集合
  clients/{clientId}: { 客戶數據 },
  completedMissions/{missionId}: { 完成記錄 }
}
```

### pointsLedger/{docId}
```javascript
{
  userId: string,
  userEmail: string,
  type: 'earn' | 'spend' | 'expire' | 'admin',
  amount: number,
  actionId: string,
  reason: string,
  balanceBefore: number,
  balanceAfter: number,
  isExpired: boolean,
  expiresAt: Timestamp,  // 12 個月後
  createdAt: Timestamp
}
```

### missions/{missionId}
```javascript
{
  title: string,
  description: string,
  icon: string,
  points: number,
  category: 'onboarding' | 'social' | 'habit' | 'daily',
  order: number,
  linkType: 'modal' | 'internal' | 'external' | 'pwa' | null,
  linkTarget: string | null,
  verificationType: 'auto' | 'manual',
  verificationField?: string,
  verificationCondition?: string,
  repeatType: 'once' | 'daily',
  isActive: boolean
}
```

### referralCodes/{code}
```javascript
{
  code: string,
  ownerId: string,
  ownerEmail: string,
  usageCount: number,
  successCount: number,
  totalPointsGenerated: number,
  isActive: boolean
}
```

---

## 7. 數據流向

### 7.1 用戶旅程

```
1. 掃描 LINE QR Code
   ↓
2. LINE Bot 發送歡迎訊息 + LIFF 按鈕
   ↓
3. LIFF 頁面輸入 Email + 推薦碼（可選）
   ↓
4. Cloud Functions 建立帳號
   ├── 檢查速率限制
   ├── 驗證推薦碼
   ├── 建立 Auth + Firestore
   └── 發送 LINE 訊息
   ↓
5. 用戶登入
   ├── Firebase Auth 驗證
   ├── 觸發 onDailyLogin
   └── 前端更新狀態
   ↓
6. 選擇客戶並使用工具
   ├── 載入客戶數據
   ├── 使用工具 → onToolUse
   └── 防抖寫入數據（10 秒）
   ↓
7. 推薦好友
   ├── 好友使用推薦碼註冊 → +100 UA
   └── 好友付費 → 雙方各 +1000 UA
```

### 7.2 點數流向

```
獲得 (Earn)
├── 每日登入        +5 UA    (每日 1 次)
├── 使用工具        +10 UA   (每日 10 次)
├── 連續 7 天登入   +50 UA   (一次)
├── 連續 30 天登入  +200 UA  (一次)
├── 推薦好友註冊    +100 UA  (每人)
├── 推薦好友付費    +1000 UA (每人)
└── 建立首位客戶    +50 UA   (一次)

過期 (Expire)
└── 獲得 12 個月後自動過期
```

---

## 8. 關鍵邏輯實現

### 8.1 會員天數制

```
會員等級轉換：
  trial (7天試用)
    ↓ (7 天後)
  grace (寬限期 7 天)
    ↓ (7 天後)
  expired (已過期)
    ↓ (付款)
  paid (付費會員)
```

### 8.2 工具數據防抖寫入

```javascript
// 用戶輸入 → 立即更新 React State
// 延遲 10 秒 → 若無新變化 → 提交到 Firestore

useEffect(() => {
  const handler = setTimeout(saveData, 10000);
  return () => clearTimeout(handler);
}, [toolData]);
```

### 8.3 業務小抄追蹤

```javascript
// 每次開啟業務小抄時記錄
const trackCheatSheetUsage = async () => {
  await updateDoc(userRef, {
    cheatSheetUsageCount: increment(1)
  });
};
```

---

## 9. API 文檔

### 前端調用範例

```typescript
// 點數系統
await pointsApi.dailyLogin()
await pointsApi.toolUse('golden_safe')
await pointsApi.getSummary()

// 任務系統
const { missions } = await missionsApi.getMissions()
await missionsApi.completeMission('set_avatar')

// Admin 付款處理
await httpsCallable('processPayment')({
  userEmail: 'user@email.com',
  days: 365,
  amount: 8999
})
```

---

## 10. 部署指南

```bash
# 前端開發
npm run dev

# Admin 後台開發
npm run dev -- admin/

# 部署 Cloud Functions
firebase deploy --only functions

# 部署 Firestore 索引
firebase deploy --only firestore:indexes

# 查看 Functions 日誌
firebase functions:log
```

**注意**：前端部署到 Vercel（push 到 GitHub 自動觸發）

---

## 附錄：預設任務列表

| ID | 任務 | 點數 | 分類 | 驗證 |
|----|------|------|------|------|
| `set_avatar` | 設定個人頭像 | 20 | onboarding | auto (photoURL) |
| `set_display_name` | 設定顯示名稱 | 15 | onboarding | auto (displayName) |
| `first_client` | 建立第一位客戶 | 20 | onboarding | auto (clients) |
| `join_line_official` | 加入 LINE 官方帳號 | 20 | social | auto (lineUserId) |
| `join_line_community` | 加入 LINE 戰友社群 | 25 | social | manual |
| `pwa_install` | 將 Ultra 加入主畫面 | 30 | habit | manual |
| `use_cheat_sheet_3` | 使用 3 次業務小抄 | 15 | habit | auto (cheatSheetUsageCount) |
| `daily_login` | 每日登入 | 5 | daily | auto (lastLoginDate) |
