rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- helper function: 檢查是否已登入 ---
    function isSignedIn() {
      return request.auth != null;
    }

    // --- helper function: 檢查是否是存取自己的資料 ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- helper function: 檢查是否為管理員 ---
    function isAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ============================================
    // 1. 系統配置（公開讀取，管理員可寫）
    // ============================================
    match /membershipTiers/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /pointsRules/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /missions/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /siteContent/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /redeemableItems/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ============================================
    // 2. 用戶相關資料
    // ============================================

    // 用戶資料：自己或管理員可讀寫
    match /users/{userId} {
      allow read: if isSignedIn() && (isOwner(userId) || isAdmin());
      allow write: if isSignedIn() && (isOwner(userId) || isAdmin());

      // 子集合（profile, preferences 等）
      match /{allSubcollections=**} {
         allow read, write: if isSignedIn() && (isOwner(userId) || isAdmin());
      }
    }

    // 點數帳本：自己可讀、管理員可讀，寫入由後端處理
    match /pointsLedger/{doc} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false;
    }

    // 兌換訂單：自己可讀、管理員可讀寫
    match /redemptionOrders/{doc} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // 推薦碼：公開讀取（用於驗證推薦碼），寫入由後端處理
    match /referralCodes/{doc} {
      allow read: if true;
      allow write: if false;
    }

    // 付款歷史：管理員可讀寫
    match /paymentHistory/{doc} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // 用戶建議：登入用戶可建立，管理員可讀寫
    match /feedbacks/{doc} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // completedMissions collectionGroup 查詢（跨用戶查詢任務完成狀態）
    match /{path=**}/completedMissions/{doc} {
      allow read: if isAdmin();
    }

    // ============================================
    // 3. 管理員/系統資料
    // ============================================
    match /admins/{doc} {
      allow read: if isSignedIn();  // 登入者可讀（用於驗證身份）
      allow write: if false;        // 僅後端可寫（防止自行加入管理員）
    }
    match /backups/{doc} {
      allow read, write: if isAdmin();
    }
    match /auditLogs/{doc} {
      allow read: if isAdmin();
      allow write: if false;
    }
    match /rateLimits/{doc} {
      allow read, write: if false;
    }

    // ============================================
    // 4. 安全保底（預設拒絕）
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
